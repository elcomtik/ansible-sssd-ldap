---
- name: pamd | add pam_mkhomedir for Debian machines
  ansible.builtin.copy:
    src: pam_mkhomedir
    dest: /usr/share/pam-configs/sssd_mkhomedir
  when: ansible_os_family == "Debian"
  notify:
    - run pam auth update

- name: pamd | add pam_mkhomedir for (legacy) RedHat machines
  ansible.builtin.command: /usr/sbin/authconfig --enablemkhomedir --update
  changed_when: false
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version is version('8', '<')
    - ansible_distribution != "Fedora"

- name: pamd | enable password auth for (legacy) RedHat machines
  ansible.builtin.command: /usr/sbin/authconfig --enablesssdauth --update
  changed_when: false
  when:
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version is version('8', '<')
    - ansible_distribution != "Fedora"

- name: autheselect | enable password auth & mkhomedir for RedHat machines
  become: true
  ansible.builtin.command: /usr/bin/authselect select sssd with-mkhomedir with-sudo --force
  changed_when: false
  when: (ansible_os_family == "RedHat" and ansible_distribution_major_version is version('8', '>=')) or
        (ansible_distribution == "Fedora")

- name: autheselect | enable oddjobd.service for RedHat machines
  become: true
  ansible.builtin.service:
    name: "oddjobd.service"
    state: "started"
    enabled: true
  when: (ansible_os_family == "RedHat" and ansible_distribution_major_version is version('8', '>=')) or
        (ansible_distribution == "Fedora")
